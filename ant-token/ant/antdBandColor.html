<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>基于主色生成色彩系统（Ant 风格）</title>
    <style>
      :root {
        --gray-0: #ffffff; --gray-5: #f9fafb; --gray-10: #f3f4f6;
        --gray-20: #e5e7eb; --gray-40: #9ca3af; --gray-60: #4b5563; --gray-80: #1f2937;
        --radius-24: 24px; --shadow-sm: 0 2px 8px rgba(17, 24, 39, 0.08);
        --chip-h: 104px;
      }
      html, body { height: 100%; margin: 0; }
      body { background: var(--gray-0); color: var(--gray-80); font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; }
      .wrap { max-width: 1080px; margin: 24px auto; padding: 16px; }
      .page-title { font-size: 20px; font-weight: 700; margin: 0 0 12px; }
      .controls { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; }
      .controls input, .controls select, .controls button { height: 36px; padding: 6px 10px; border: 1px solid var(--gray-20); border-radius: 8px; font-size: 14px; background: var(--gray-0); }
      .section-title { font-size: 16px; font-weight: 700; margin: 24px 0 8px; }
      .grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; }
      @media (max-width: 900px){ .grid { grid-template-columns: repeat(3, 1fr); } }
      @media (max-width: 560px){ .grid { grid-template-columns: repeat(2, 1fr); } .wrap { padding: 12px; } }
      .chip { border-radius: var(--radius-24); background: var(--gray-0); box-shadow: var(--shadow-sm); border: 1px solid var(--gray-20); overflow: hidden; display: grid; align-content: end; height: var(--chip-h); }
      .chip-color { height: calc(var(--chip-h) - 36px); }
      .chip-info { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; align-items: center; padding: 8px 12px; border-top: 1px solid var(--gray-20); background: var(--gray-5); color: var(--gray-60); font-size: 13px; }
      .info-left { justify-self: start; font-weight: 700; }
      .info-right { justify-self: end; font-weight: 500; color: var(--gray-40); }
      .row { display: flex; flex-wrap: wrap; gap: 12px; }
      .note { font-size: 13px; color: var(--gray-40); margin: 6px 0; }
      .kpi { font-size: 13px; color: var(--gray-60); display: flex; gap: 12px; margin: 6px 0; }
    </style>
    <script src="../color-scale.js"></script>
  </head>
  <body>
    <main class="wrap" role="main">
      <h1 class="page-title">输入主色，生成色彩系统</h1>
      <div class="controls">
        <label for="brandHex">主色 HEX</label>
        <input id="brandHex" type="text" value="#1677ff" placeholder="#RRGGBB" />
        <label for="boardSize">色板数量</label>
        <select id="boardSize">
          <option value="12">12</option>
          <option value="16">16</option>
          <option value="24">24</option>
        </select>
        <button id="btnGen">生成</button>
      </div>

      <section aria-labelledby="title-primary">
        <h2 class="section-title" id="title-primary">主色分析</h2>
        <div class="kpi" id="primaryKpi"></div>
        <div class="row" id="primaryRow"></div>
      </section>

      <section aria-labelledby="title-board">
        <h2 class="section-title" id="title-board">同频色板（邻近色环）</h2>
        <div class="note">基于主色的 OKLCH（保持 L/C，按 360°/N 取邻近色，相对同频展示）。</div>
        <div class="grid" id="boardGrid"></div>
      </section>

      <section aria-labelledby="title-scale">
        <h2 class="section-title" id="title-scale">同色系色阶（10–90 Band）</h2>
        <div class="note">自动匹配最近的 Band（依据 hue），若主色等于该 Band 的 50，直接显示 Figma 真值。</div>
        <div class="row" id="bandRow"></div>
        <div class="note" id="bandMatch"></div>
      </section>

      <section aria-labelledby="title-ant10">
        <h2 class="section-title" id="title-ant10">Ant 10 色阶（color-1 → color-10）</h2>
        <div class="note">根据主色生成 10 色阶，黑端更深（L≈0.10），更贴近示例 #1890ff。</div>
        <div class="row" id="antRow"></div>
        <div class="note" id="antNote"></div>
      </section>
    </main>

    <script>
      // Helpers
      function createChip(label, hex){
        const chip = document.createElement('div'); chip.className = 'chip';
        const color = document.createElement('div'); color.className = 'chip-color'; color.style.background = hex;
        const info = document.createElement('div'); info.className = 'chip-info';
        const left = document.createElement('span'); left.className = 'info-left'; left.textContent = label;
        const right = document.createElement('span'); right.className = 'info-right'; right.textContent = hex.toLowerCase();
        info.appendChild(left); info.appendChild(right); chip.appendChild(color); chip.appendChild(info); return chip;
      }
      function clamp01(x){ return Math.min(1, Math.max(0, x)); }

      // Parse anchors from bandcolor.css
      async function loadAnchors(url){
        const res = await fetch(url); const css = await res.text();
        const SERIES_NAME_MAP = new Map([
          ['Gray','gray'], ['Neutral','gray'], ['Brand','success'], ['Success','success'],
          ['Green','success'], ['Teal','success'], ['Cyan','cyan'], ['Blue','blue'],
          ['Indigo','indigo'], ['Violet','violet'], ['Purple','purple'], ['Fuchsia','fuchsia'],
          ['Pink','pink'], ['Red','red'], ['Orange','orange'], ['Amber','amber'], ['Yellow','yellow']
        ]);
        const re = /\/\*\s*([A-Za-z]+)\/(\d{1,3})\s*\*\/[^#]*#([0-9A-Fa-f]{6})/g;
        const anchors = {}; let m;
        while ((m = re.exec(css))){
          const rawSeries = m[1]; const shade = parseInt(m[2], 10); const hex = `#${m[3]}`.toLowerCase();
          const series = SERIES_NAME_MAP.get(rawSeries) || rawSeries.toLowerCase();
          anchors[series] = anchors[series] || {}; anchors[series][shade] = hex;
        }
        return anchors;
      }

      // Pick nearest series by hue of 50
      function pickNearestSeriesByHue(anchors, hex50){
        const base = hexToOklch(hex50); let best = null; let bestDist = Infinity;
        Object.entries(anchors).forEach(([name, series]) => {
          const hex50Series = series[50]; if (!hex50Series) return;
          const h = hexToOklch(hex50Series).h; const d = Math.abs(normalizeHueDelta(base.h - h));
          if (d < bestDist){ bestDist = d; best = name; }
        });
        return best;
      }

      // Generate same-frequency board: keep L/C, step hue by 360/N, gamut-safe
      function generateBoard(hex, count){
        const base = hexToOklch(hex); const arr = []; const step = 360 / count;
        for (let i = 0; i < count; i++){
          const h = (base.h + i * step) % 360; const L = clamp01(base.L); const C = Math.max(0, base.C);
          const hexOut = (function(){
            // Reuse generator’s sRGB compression
            return oklchToHexGamutSafe({ L, C, h });
          })();
          arr.push({ label: Math.round(h), hex: hexOut });
        }
        return arr;
      }

      function renderPrimary(hex){
        const kpi = document.getElementById('primaryKpi'); const row = document.getElementById('primaryRow');
        row.innerHTML = ''; const o = hexToOklch(hex);
        kpi.textContent = `OKLCH: L=${o.L.toFixed(3)} C=${o.C.toFixed(3)} h=${o.h.toFixed(1)}°`;
        row.appendChild(createChip('Primary', hex));
      }

      function renderBoard(hex, n){
        const grid = document.getElementById('boardGrid'); grid.innerHTML = '';
        const board = generateBoard(hex, n);
        board.forEach((b,i) => grid.appendChild(createChip(`${i+1}`, b.hex)));
      }

      function renderBand(hex50, anchors, presets){
        const row = document.getElementById('bandRow'); const note = document.getElementById('bandMatch');
        row.innerHTML = ''; note.textContent = '';
        const chosen = pickNearestSeriesByHue(anchors, hex50);
        const preset = chosen ? presets[chosen] : undefined;
        const seriesAnchors = chosen ? anchors[chosen] : undefined;
        const band = generateBandFrom50(hex50, (preset || seriesAnchors) ? { preset, anchors: seriesAnchors } : {});
        [10,20,30,40,50,60,70,80,90].forEach(s => row.appendChild(createChip(s, band[s])));
        if (chosen){ note.textContent = `匹配系列：${chosen}${seriesAnchors && seriesAnchors[50] && seriesAnchors[50].toLowerCase() === hex50.toLowerCase() ? '（50 完全匹配，显示 Figma 真值）' : ''}`; }
      }

      // Ant 10-step generator aiming deeper darkest tone for examples like #1890ff
      function generateAnt10(hex){
        const base = hexToOklch(hex);
        const whiteL = 0.985;
        const blackL = 0.10; // deeper black end
        const hue = base.h;
        const tLight = [0.92,0.84,0.72,0.60,0.48];
        const cLight = [0.20,0.35,0.55,0.75,0.95];
        const tDark  = [0.18,0.38,0.60,0.82,0.97];
        const cDark  = [1.05,0.95,0.85,0.70,0.55];
        const out = [];
        // color-1..color-5 (lighter)
        for (let i = 0; i < 5; i++){
          const L = base.L + (whiteL - base.L) * tLight[i];
          const C = base.C * cLight[i];
          out.push(oklchToHexGamutSafe({ L, C, h: hue }));
        }
        // color-6..color-10 (darker)
        for (let i = 0; i < 5; i++){
          const L = base.L + (blackL - base.L) * tDark[i];
          const C = base.C * cDark[i];
          out.push(oklchToHexGamutSafe({ L, C, h: hue }));
        }
        return out;
      }

      function renderAnt10(hex){
        const row = document.getElementById('antRow'); const note = document.getElementById('antNote');
        row.innerHTML = ''; note.textContent = '';
        const arr = generateAnt10(hex);
        arr.forEach((hx, idx) => row.appendChild(createChip(`color-${idx+1}`, hx)));
        const o = hexToOklch(hex);
        note.textContent = `基于主色 OKLCH(h=${o.h.toFixed(1)}°)，黑端目标 L≈0.10，按非线性 L/C 分配生成。`;
      }

      (async function init(){
        const anchors = await loadAnchors('../bandcolor.css');
        const presets = fitAllSeriesFromFigma(anchors);
        const brandInput = document.getElementById('brandHex');
        const sizeSelect = document.getElementById('boardSize');
        function generate(){
          const hex = brandInput.value.trim(); const n = parseInt(sizeSelect.value, 10);
          renderPrimary(hex); renderBoard(hex, n); renderBand(hex, anchors, presets); renderAnt10(hex);
        }
        document.getElementById('btnGen').addEventListener('click', generate);
        generate();
      })();
    </script>
  </body>
</html>
